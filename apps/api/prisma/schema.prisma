// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider        = "prisma-client-js"
  output          = "../generated/prisma"
  binaryTargets   = ["native", "linux-musl-openssl-3.0.x"]
  previewFeatures = ["postgresqlExtensions", "views", "fullTextSearchPostgres"]
}

datasource db {
  provider = "postgresql"
}

// =========================================
// ENUMS (Định nghĩa các tập giá trị cố định)
// =========================================

enum UserRole {
  ADMIN    // Chủ shop
  CUSTOMER // Khách mua hàng
}

enum OrderStatus {
  PENDING    // Chờ thanh toán
  CONFIRMED  // Đã xác nhận
  PROCESSING // Đang đóng gói
  SHIPPING   // Đang giao
  DELIVERED  // Giao thành công
  CANCELLED  // Đã hủy
  RETURNED   // Trả hàng
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum DiscountType {
  PERCENTAGE   // Giảm theo %
  FIXED_AMOUNT // Giảm số tiền cụ thể
}

// =========================================
// USER & AUTHENTICATION
// =========================================

model User {
  id        String   @id @default(uuid())
  email     String   @unique @db.VarChar(255)
  password  String   @db.Text // Lưu hash password
  fullName  String?  @db.VarChar(100)
  phone     String?  @db.VarChar(15)
  avatar    String?  @db.Text
  role      UserRole @default(CUSTOMER)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  addresses Address[]
  orders    Order[]
  reviews   Review[]
  cart      Cart? // 1 User chỉ có 1 giỏ hàng active

  @@map("users") // Tên bảng trong DB là 'users'
}

model Address {
  id        String  @id @default(cuid())
  userId    String
  recipient String  @db.VarChar(100) // Tên người nhận
  phone     String  @db.VarChar(15)
  street    String  @db.Text
  city      String  @db.VarChar(50)
  district  String  @db.VarChar(50)
  ward      String  @db.VarChar(50)
  isDefault Boolean @default(false)

  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("addresses")
}

// =========================================
// PRODUCT MANAGEMENT (Complex Logic)
// =========================================

model Category {
  id          String  @id @default(cuid())
  name        String  @unique @db.VarChar(100)
  slug        String  @unique @db.VarChar(100) // URL thân thiện SEO
  description String? @db.Text
  image       String? @db.Text
  
  // Self-relation để làm danh mục đa cấp (Ví dụ: Thời trang nam -> Áo -> Áo thun)
  parentId    String? 
  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")
  
  products    Product[]

  @@map("categories")
}

model Product {
  id          String   @id @default(cuid())
  name        String   @db.VarChar(255)
  slug        String   @unique @db.VarChar(255)
  description String?  @db.Text // Hỗ trợ HTML/Markdown
  
  // Giá cơ bản (để hiển thị "Từ 100k"). Giá thật nằm ở Variant.
  basePrice   Decimal  @db.Decimal(12, 2) 
  
  categoryId  String
  category    Category @relation(fields: [categoryId], references: [id])
  
  isPublished Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  images      ProductImage[]
  variants    ProductVariant[] // Các biến thể (SKU)
  options     ProductOption[]  // Định nghĩa options (Màu, Size)
  reviews     Review[]

  @@index([categoryId])
  @@index([slug])
  @@map("products")
}

model ProductImage {
  id        String  @id @default(cuid())
  url       String  @db.Text
  altText   String? @db.VarChar(255)
  isMain    Boolean @default(false) // Ảnh đại diện
  
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("product_images")
}

// Định nghĩa Option: Ví dụ sản phẩm có Option là "Màu sắc" và "Kích thước"
model ProductOption {
  id        String @id @default(cuid())
  name      String @db.VarChar(50) // VD: "Color", "Size"
  
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  values    ProductOptionValue[]

  @@map("product_options")
}

// Định nghĩa giá trị Option: "Đỏ", "Xanh", "S", "M"
model ProductOptionValue {
  id        String @id @default(cuid())
  value     String @db.VarChar(50) // VD: "Red", "XL"
  
  optionId  String
  option    ProductOption @relation(fields: [optionId], references: [id], onDelete: Cascade)
  
  // Many-to-many: Một giá trị option có thể thuộc về nhiều Variant
  variants  ProductVariant[] 

  @@map("product_option_values")
}

// SKU thực tế (Sự kết hợp của các Option Values)
model ProductVariant {
  id        String   @id @default(cuid())
  sku       String   @unique @db.VarChar(50) // Mã kho: PROD-RED-XL
  price     Decimal  @db.Decimal(12, 2) // Giá riêng cho biến thể này
  stock     Int      @default(0) // Quản lý tồn kho
  
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  // Liên kết với các giá trị option (Red, XL)
  options   ProductOptionValue[] 
  
  cartItems CartItem[]
  orderItems OrderItem[]

  @@map("product_variants")
}

// =========================================
// CART & ORDER SYSTEM
// =========================================

model Cart {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  items     CartItem[]
  updatedAt DateTime @updatedAt

  @@map("carts")
}

model CartItem {
  id        String   @id @default(cuid())
  cartId    String
  cart      Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  
  variantId String
  variant   ProductVariant @relation(fields: [variantId], references: [id])
  
  quantity  Int      @default(1)
  
  @@unique([cartId, variantId]) // Một variant chỉ xuất hiện 1 lần trong 1 cart
  @@map("cart_items")
}

model Order {
  id            String      @id @default(cuid())
  code          String      @unique // Mã đơn hàng ngắn gọn cho khách đọc (VD: #ORD-1234)
  
  userId        String?     // Nullable để hỗ trợ khách vãng lai (nếu cần)
  user          User?       @relation(fields: [userId], references: [id])
  
  status        OrderStatus   @default(PENDING)
  paymentStatus PaymentStatus @default(PENDING)
  
  totalAmount   Decimal     @db.Decimal(12, 2) // Tổng tiền sau cùng
  shippingFee   Decimal     @default(0) @db.Decimal(12, 2)
  discountValue Decimal     @default(0) @db.Decimal(12, 2)

  // Snapshot địa chỉ giao hàng (Lưu cứng dữ liệu text để không bị đổi khi user sửa profile)
  shippingAddressJson Json  @db.JsonB 
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  items         OrderItem[]

  @@map("orders")
}

// Lưu lại trạng thái sản phẩm TẠI THỜI ĐIỂM MUA (Snapshot)
model OrderItem {
  id          String   @id @default(cuid())
  orderId     String
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  variantId   String?  // Có thể null nếu sản phẩm bị xóa sau này
  variant     ProductVariant? @relation(fields: [variantId], references: [id])
  
  productName String   @db.VarChar(255) // Lưu cứng tên
  variantName String   @db.VarChar(255) // Lưu cứng tên biến thể (VD: Red - XL)
  price       Decimal  @db.Decimal(12, 2) // Lưu cứng giá lúc mua
  quantity    Int
  
  @@map("order_items")
}

// =========================================
// MARKETING & SOCIAL
// =========================================

model Voucher {
  id          String       @id @default(cuid())
  code        String       @unique @db.VarChar(20)
  type        DiscountType
  value       Decimal      @db.Decimal(12, 2) // Giá trị giảm (số tiền hoặc %)
  
  minSpend    Decimal?     @db.Decimal(12, 2) // Đơn tối thiểu
  maxDiscount Decimal?     @db.Decimal(12, 2) // Giảm tối đa (cho loại %)
  
  usageLimit  Int          @default(100) // Tổng số lần dùng
  usedCount   Int          @default(0)   // Đã dùng
  
  startDate   DateTime
  endDate     DateTime
  isActive    Boolean      @default(true)

  @@map("vouchers")
}

model Review {
  id        String   @id @default(cuid())
  rating    Int      @default(5) // 1-5 sao
  comment   String?  @db.Text
  
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  
  createdAt DateTime @default(now())

  @@map("reviews")
}