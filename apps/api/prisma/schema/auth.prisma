// =========================================
// OAUTH & AUTHENTICATION
// =========================================

// Lưu thông tin đăng nhập OAuth (Google, Facebook, etc.)
model ExternalAccount {
  id            String        @id @default(cuid())
  provider      OAuthProvider
  providerId    String        @db.VarChar(255) // ID từ provider (VD: Google user ID)
  providerEmail String?       @db.VarChar(255) // Email từ provider
  accessToken   String?       @db.Text // Encrypted access token
  refreshToken  String?       @db.Text // Encrypted refresh token
  expiresAt     DateTime? // Token expiration

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Unique constraint: một provider chỉ có thể liên kết 1 lần với 1 user
  @@unique([provider, providerId])
  @@unique([provider, userId])
  @@index([userId])
  @@index([provider, providerId])
  @@map("external_accounts")
}

// Quản lý các phương thức MFA của user
model UserMFAMethod {
  id         String    @id @default(cuid())
  methodType MFAMethod // TOTP, SMS, EMAIL, BACKUP_CODE
  secret     String?   @db.Text // Encrypted secret (cho TOTP)
  phone      String?   @db.VarChar(15) // Cho SMS
  isActive   Boolean   @default(true)
  isVerified Boolean   @default(false) // Đã verify chưa

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  lastUsedAt DateTime? // Lần cuối sử dụng

  @@index([userId])
  @@map("mfa_methods")
}

// Backup codes cho MFA (dùng 1 lần)
model MFABackupCode {
  id     String    @id @default(cuid())
  code   String    @db.VarChar(20) // Hashed backup code
  isUsed Boolean   @default(false)
  usedAt DateTime?

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([userId])
  @@map("mfa_backup_codes")
}

// Log thiết bị đăng nhập
model Device {
  id          String     @id @default(cuid())
  name        String?    @db.VarChar(255) // Tên thiết bị (VD: "iPhone 14 Pro")
  type        DeviceType @default(UNKNOWN)
  userAgent   String?    @db.Text // User agent string
  ipAddress   String?    @db.VarChar(45) // IPv4 hoặc IPv6
  fingerprint String?    @db.VarChar(255) // Device fingerprint

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  isTrusted  Boolean  @default(false) // User đã trust thiết bị này
  lastSeenAt DateTime @default(now())
  createdAt  DateTime @default(now())

  // Relations
  session Session? // Session hiện tại của thiết bị này (one-to-one)

  @@index([userId])
  @@index([fingerprint])
  @@map("devices")
}

// Quản lý session đăng nhập
model Session {
  id           String  @id @default(cuid())
  token        String  @unique @db.VarChar(255) // Session token (JWT hoặc random string)
  refreshToken String? @unique @db.VarChar(255) // Refresh token

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  deviceId String? @unique // Link với Device (unique: một device chỉ có một session)
  device   Device? @relation(fields: [deviceId], references: [id], onDelete: SetNull)

  ipAddress String? @db.VarChar(45)
  userAgent String? @db.Text

  status    SessionStatus @default(ACTIVE)
  expiresAt DateTime // Thời gian hết hạn
  revokedAt DateTime? // Thời gian bị revoke

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([token])
  @@index([status])
  @@index([expiresAt])
  @@map("sessions")
}
