// Copyright (c) 2026 Xiro The Dev <lethanhtrung.trungle@gmail.com>
//
// Source Available License
//
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to:
// - View and study the Software for educational purposes
// - Fork this repository on GitHub for personal reference
// - Share links to this repository
//
// THE FOLLOWING ARE PROHIBITED:
// - Using the Software in production or commercial applications
// - Copying substantial portions of the Software into other projects
// - Distributing modified versions of the Software
// - Removing or altering copyright notices
//
// For commercial licensing or usage permissions, contact: lethanhtrung.trungle@gmail.com
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND.
//
// =========================================
// OAUTH & AUTHENTICATION
// =========================================

// Store OAuth login information (Google, Facebook, etc.)
model ExternalAccount {
  id            String        @id @default(cuid())
  provider      OAuthProvider
  providerId    String        @db.VarChar(255) // ID from provider (e.g.: Google user ID)
  providerEmail String?       @db.VarChar(255) // Email from provider
  accessToken   String?       @db.Text // Encrypted access token
  refreshToken  String?       @db.Text // Encrypted refresh token
  expiresAt     DateTime? // Token expiration

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Unique constraint: a provider can only be linked once with a user
  @@unique([provider, providerId])
  @@unique([provider, userId])
  @@index([userId])
  @@index([provider, providerId])
  @@map("external_accounts")
}

// Manage user MFA methods
model UserMFAMethod {
  id         String    @id @default(cuid())
  methodType MFAMethod // TOTP, SMS, EMAIL, BACKUP_CODE
  secret     String?   @db.Text // Encrypted secret (for TOTP)
  phone      String?   @db.VarChar(15) // For SMS
  isActive   Boolean   @default(true)
  isVerified Boolean   @default(false) // Whether verified

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  lastUsedAt DateTime? // Last time used

  @@index([userId])
  @@map("mfa_methods")
}

// Backup codes for MFA (single use)
model MFABackupCode {
  id     String    @id @default(cuid())
  code   String    @db.VarChar(20) // Hashed backup code
  isUsed Boolean   @default(false)
  usedAt DateTime?

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([userId])
  @@map("mfa_backup_codes")
}

// Log login devices
model Device {
  id          String     @id @default(cuid())
  name        String?    @db.VarChar(255) // Device name (e.g.: "iPhone 14 Pro")
  type        DeviceType @default(UNKNOWN)
  userAgent   String?    @db.Text // User agent string
  ipAddress   String?    @db.VarChar(45) // IPv4 or IPv6
  fingerprint String?    @db.VarChar(255) // Device fingerprint

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  isTrusted  Boolean  @default(false) // User has trusted this device
  lastSeenAt DateTime @default(now())
  createdAt  DateTime @default(now())

  // Relations
  session Session? // Current session of this device (one-to-one)

  @@index([userId])
  @@index([fingerprint])
  @@map("devices")
}

// Manage login sessions
model Session {
  id           String  @id @default(cuid())
  token        String  @unique @db.Text // Session token (JWT or random string)
  refreshToken String? @unique @db.Text // Refresh token

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  deviceId String? @unique // Link to Device (unique: one device has only one session)
  device   Device? @relation(fields: [deviceId], references: [id], onDelete: SetNull)

  ipAddress String? @db.VarChar(45)
  userAgent String? @db.Text

  status    SessionStatus @default(ACTIVE)
  expiresAt DateTime // Expiration time
  revokedAt DateTime? // Revocation time

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([token])
  @@index([status])
  @@index([expiresAt])
  @@map("sessions")
}
