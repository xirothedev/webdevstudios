// =========================================
// PRODUCT MANAGEMENT (Complex Logic)
// =========================================

model Category {
  id          String  @id @default(cuid())
  name        String  @unique @db.VarChar(100)
  slug        String  @unique @db.VarChar(100) // URL thân thiện SEO
  description String? @db.Text
  image       String? @db.Text

  // Self-relation để làm danh mục đa cấp (Ví dụ: Thời trang nam -> Áo -> Áo thun)
  parentId String?
  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[] @relation("CategoryHierarchy")

  products Product[]

  @@map("categories")
}

model Product {
  id          String  @id @default(cuid())
  name        String  @db.VarChar(255)
  slug        String  @unique @db.VarChar(255)
  description String? @db.Text // Hỗ trợ HTML/Markdown

  // Giá cơ bản (để hiển thị "Từ 100k"). Giá thật nằm ở Variant.
  basePrice Decimal @db.Decimal(12, 2)

  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])

  isPublished Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  images   ProductImage[]
  variants ProductVariant[] // Các biến thể (SKU)
  options  ProductOption[] // Định nghĩa options (Màu, Size)
  reviews  Review[]

  @@index([categoryId])
  @@index([slug])
  @@map("products")
}

model ProductImage {
  id      String  @id @default(cuid())
  url     String  @db.Text
  altText String? @db.VarChar(255)
  isMain  Boolean @default(false) // Ảnh đại diện

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("product_images")
}

// Định nghĩa Option: Ví dụ sản phẩm có Option là "Màu sắc" và "Kích thước"
model ProductOption {
  id   String @id @default(cuid())
  name String @db.VarChar(50) // VD: "Color", "Size"

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  values ProductOptionValue[]

  @@map("product_options")
}

// Định nghĩa giá trị Option: "Đỏ", "Xanh", "S", "M"
model ProductOptionValue {
  id    String @id @default(cuid())
  value String @db.VarChar(50) // VD: "Red", "XL"

  optionId String
  option   ProductOption @relation(fields: [optionId], references: [id], onDelete: Cascade)

  // Many-to-many: Một giá trị option có thể thuộc về nhiều Variant
  variants ProductVariant[]

  @@map("product_option_values")
}

// SKU thực tế (Sự kết hợp của các Option Values)
model ProductVariant {
  id    String  @id @default(cuid())
  sku   String  @unique @db.VarChar(50) // Mã kho: PROD-RED-XL
  price Decimal @db.Decimal(12, 2) // Giá riêng cho biến thể này
  stock Int     @default(0) // Quản lý tồn kho

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Liên kết với các giá trị option (Red, XL)
  options ProductOptionValue[]

  cartItems  CartItem[]
  orderItems OrderItem[]

  @@map("product_variants")
}
