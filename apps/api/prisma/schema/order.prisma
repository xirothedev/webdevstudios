// =========================================
// CART & ORDER SYSTEM
// =========================================

model Cart {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  items     CartItem[]
  updatedAt DateTime   @updatedAt

  @@map("carts")
}

model CartItem {
  id     String @id @default(cuid())
  cartId String
  cart   Cart   @relation(fields: [cartId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id])

  size     ProductSize? // Size sản phẩm (chỉ áo thun có, nullable)
  quantity Int           @default(1)

  @@unique([cartId, productId, size]) // Một sản phẩm + size chỉ xuất hiện 1 lần trong 1 cart
  @@index([cartId])
  @@map("cart_items")
}

model Order {
  id   String @id @default(cuid())
  code String @unique // Mã đơn hàng ngắn gọn cho khách đọc (VD: #ORD-1234)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  status        OrderStatus   @default(PENDING)
  paymentStatus PaymentStatus @default(PENDING)

  totalAmount   Decimal @db.Money // Tổng tiền sau cùng
  shippingFee   Decimal @default(0) @db.Money
  discountValue Decimal @default(0) @db.Money

  // Snapshot địa chỉ giao hàng (Lưu cứng dữ liệu text để không bị đổi khi user sửa profile)
  shippingAddressJson Json @db.JsonB

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items OrderItem[]

  @@map("orders")
}

// Lưu lại trạng thái sản phẩm TẠI THỜI ĐIỂM MUA (Snapshot)
model OrderItem {
  id      String @id @default(cuid())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId String? // Có thể null nếu sản phẩm bị xóa sau này
  product   Product? @relation(fields: [productId], references: [id])

  // Snapshot data (lưu cứng để không bị ảnh hưởng khi sản phẩm thay đổi)
  productSlug ProductSlug // Lưu slug để dễ tra cứu
  productName String      @db.VarChar(255) // Lưu cứng tên sản phẩm
  size        ProductSize? // Size sản phẩm (nếu có)
  price       Decimal      @db.Money // Lưu cứng giá lúc mua
  quantity    Int

  @@index([orderId])
  @@map("order_items")
}
