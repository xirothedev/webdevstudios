// =========================================
// CART & ORDER SYSTEM
// =========================================

model Cart {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  items     CartItem[]
  updatedAt DateTime   @updatedAt

  @@map("carts")
}

model CartItem {
  id     String @id @default(cuid())
  cartId String
  cart   Cart   @relation(fields: [cartId], references: [id], onDelete: Cascade)

  variantId String
  variant   ProductVariant @relation(fields: [variantId], references: [id])

  quantity Int @default(1)

  @@unique([cartId, variantId]) // Một variant chỉ xuất hiện 1 lần trong 1 cart
  @@map("cart_items")
}

model Order {
  id   String @id @default(cuid())
  code String @unique // Mã đơn hàng ngắn gọn cho khách đọc (VD: #ORD-1234)

  userId String? // Nullable để hỗ trợ khách vãng lai (nếu cần)
  user   User?   @relation(fields: [userId], references: [id])

  status        OrderStatus   @default(PENDING)
  paymentStatus PaymentStatus @default(PENDING)

  totalAmount   Decimal @db.Decimal(12, 2) // Tổng tiền sau cùng
  shippingFee   Decimal @default(0) @db.Decimal(12, 2)
  discountValue Decimal @default(0) @db.Decimal(12, 2)

  // Snapshot địa chỉ giao hàng (Lưu cứng dữ liệu text để không bị đổi khi user sửa profile)
  shippingAddressJson Json @db.JsonB

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items OrderItem[]

  @@map("orders")
}

// Lưu lại trạng thái sản phẩm TẠI THỜI ĐIỂM MUA (Snapshot)
model OrderItem {
  id      String @id @default(cuid())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  variantId String? // Có thể null nếu sản phẩm bị xóa sau này
  variant   ProductVariant? @relation(fields: [variantId], references: [id])

  productName String  @db.VarChar(255) // Lưu cứng tên
  variantName String  @db.VarChar(255) // Lưu cứng tên biến thể (VD: Red - XL)
  price       Decimal @db.Decimal(12, 2) // Lưu cứng giá lúc mua
  quantity    Int

  @@map("order_items")
}
