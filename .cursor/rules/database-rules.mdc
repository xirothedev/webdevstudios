---
globs: apps/api/prisma/**/*.prisma
alwaysApply: false
---

# Database Rules - Prisma Schema

## ðŸŽ¯ Schema Strategy

### Simplified Schema for 4 Fixed Products
- **Products**: Chá»‰ cÃ³ 4 sáº£n pháº©m cá»‘ Ä‘á»‹nh (Ão thun, Pad chuá»™t, DÃ¢y Ä‘eo, MÃ³c khÃ³a)
- **No Categories**: KhÃ´ng cÃ³ Category model (khÃ´ng cáº§n vÃ¬ chá»‰ 4 sáº£n pháº©m)
- **No Variants**: KhÃ´ng cÃ³ ProductVariant phá»©c táº¡p, chá»‰ cÃ³ ProductSizeStock cho Ã¡o thun
- **Type Safety**: Sá»­ dá»¥ng enums (ProductSlug, ProductSize) thay vÃ¬ strings

## ðŸ“ Schema File Organization

### File Structure
```
prisma/schema/
â”œâ”€â”€ base.prisma        # Base configuration, datasource, generator
â”œâ”€â”€ enums.prisma       # Táº¥t cáº£ enums
â”œâ”€â”€ user.prisma        # User, Session, Device models
â”œâ”€â”€ auth.prisma        # Authentication related (OAuth, MFA)
â”œâ”€â”€ product.prisma     # Product, ProductImage, ProductSizeStock
â”œâ”€â”€ order.prisma       # Order, OrderItem, Cart, CartItem
â””â”€â”€ marketing.prisma   # Review, Discount, Promotion
```

### Schema Composition
- **Base**: Datasource, generator config
- **Enums**: Táº¥t cáº£ enums táº­p trung má»™t file
- **Domain Models**: TÃ¡ch theo domain (user, product, order, marketing)

## ðŸ”¢ Enum Definitions

### Product Enums
```prisma
enum ProductSlug {
  AO_THUN    // Ão thun WebDev Studios
  PAD_CHUOT  // Pad chuá»™t WebDev Studios
  DAY_DEO    // DÃ¢y Ä‘eo WebDev Studios
  MOC_KHOA   // MÃ³c khÃ³a WebDev Studios
}

enum ProductSize {
  S
  M
  L
  XL
}
```

### Rules for Enums
- **Location**: Táº¥t cáº£ enums trong `enums.prisma`
- **Naming**: `PascalCase` vá»›i `SCREAMING_SNAKE_CASE` values
- **Comments**: LuÃ´n cÃ³ comment giáº£i thÃ­ch cho má»—i enum value
- **Type Safety**: Sá»­ dá»¥ng enums thay vÃ¬ strings trong code

## ðŸ“Š Model Definitions

### Product Model
```prisma
model Product {
  id          String      @id @default(cuid())
  slug        ProductSlug @unique // Enum Ä‘áº£m báº£o chá»‰ cÃ³ 4 sáº£n pháº©m
  name        String      @db.VarChar(255)
  description String      @db.Text
  
  // Pricing
  priceCurrent  Decimal @db.Money
  priceOriginal Decimal? @db.Money
  priceDiscount Decimal? @db.Money
  
  // Stock & Sizes
  stock       Int     @default(0)
  hasSizes    Boolean @default(false) // Chá»‰ Ã¡o thun = true
  badge       String? @db.VarChar(50)
  
  // Ratings
  ratingValue Decimal @default(0) @db.Decimal(3, 2)
  ratingCount Int     @default(0)
  
  // Relations
  images     ProductImage[]
  sizeStocks ProductSizeStock[] // Chá»‰ cho Ã¡o thun
  cartItems  CartItem[]
  orderItems OrderItem[]
  reviews    Review[]
}
```

### Key Rules
1. **ProductSlug**: Báº¯t buá»™c unique, enum type
2. **Stock Management**: 
   - `Product.stock` cho sáº£n pháº©m khÃ´ng cÃ³ size
   - `ProductSizeStock` cho Ã¡o thun (theo size)
3. **Pricing**: Sá»­ dá»¥ng `@db.Money` type cho tiá»n tá»‡
4. **Ratings**: Decimal(3,2) cho rating (0-5.00)

### ProductSizeStock Model
```prisma
model ProductSizeStock {
  id     String      @id @default(cuid())
  size   ProductSize
  stock  Int         @default(0)
  
  productId String
  product   Product @relation(...)
  
  @@unique([productId, size]) // Má»—i size cá»§a 1 sáº£n pháº©m chá»‰ cÃ³ 1 record
}
```

**Purpose**: Quáº£n lÃ½ stock theo size cho Ã¡o thun. CÃ¡c sáº£n pháº©m khÃ¡c khÃ´ng cÃ³ size, dÃ¹ng `Product.stock` trá»±c tiáº¿p.

## ðŸ”— Relations

### Best Practices
- **Cascade Delete**: Sá»­ dá»¥ng `onDelete: Cascade` cho child records (e.g., ProductImage)
- **Optional Relations**: DÃ¹ng `?` khi relation cÃ³ thá»ƒ null
- **Indexes**: ThÃªm indexes cho foreign keys vÃ  frequently queried fields
- **Example**:
  ```prisma
  model ProductImage {
    productId String
    product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
    
    @@index([productId, order]) // Composite index
  }
  ```

## ðŸ“ Naming Conventions

### Models
- **Singular**: `Product`, `Order`, `Cart` (khÃ´ng pháº£i `Products`, `Orders`)
- **PascalCase**: Táº¥t cáº£ model names
- **Descriptive**: TÃªn model pháº£i mÃ´ táº£ rÃµ rÃ ng

### Fields
- **camelCase**: `productId`, `createdAt`, `ratingValue`
- **Boolean Prefix**: `is`, `has`, `can` (e.g., `isPublished`, `hasSizes`)
- **Timestamps**: `createdAt`, `updatedAt` (standard)

### Relations
- **Singular**: `product`, `user` (khÃ´ng pháº£i `products`, `users`)
- **Plural Arrays**: `images`, `reviews`, `orderItems`

## ðŸ—„ï¸ Database Types

### Prisma Types Mapping
- **String**: `@db.VarChar(255)` cho short strings, `@db.Text` cho long text
- **Decimal**: `@db.Decimal(precision, scale)` cho money/ratings
- **Money**: `@db.Money` cho tiá»n tá»‡ (PostgreSQL money type)
- **DateTime**: Standard `DateTime` type
- **Boolean**: Standard `Boolean` type
- **Int**: Standard `Int` type

### Examples
```prisma
priceCurrent  Decimal @db.Money           // Money type
ratingValue   Decimal @db.Decimal(3, 2)   // 0.00 to 5.00
name          String  @db.VarChar(255)    // Short string
description   String  @db.Text            // Long text
stock         Int     @default(0)          // Integer with default
```

## ðŸ”„ Migrations

### Migration Workflow
1. **Edit Schema**: Sá»­a cÃ¡c file `.prisma` trong `prisma/schema/`
2. **Generate**: `pnpm prisma:generate` Ä‘á»ƒ generate Prisma Client
3. **Create Migration**: `pnpm prisma:migrate` Ä‘á»ƒ táº¡o migration
4. **Review**: Kiá»ƒm tra migration SQL trÆ°á»›c khi apply
5. **Apply**: Migration sáº½ tá»± Ä‘á»™ng apply trong dev mode

### Migration Rules
- **Never Edit Migrations**: KhÃ´ng sá»­a migration files Ä‘Ã£ táº¡o
- **Descriptive Names**: TÃªn migration pháº£i mÃ´ táº£ rÃµ thay Ä‘á»•i
- **Backup**: Backup database trÆ°á»›c khi cháº¡y migration production
- **Test**: Test migrations trÃªn staging trÆ°á»›c

## ðŸš« Anti-Patterns

### âŒ Don't Do This
- âŒ Táº¡o Category model (khÃ´ng cáº§n cho 4 sáº£n pháº©m)
- âŒ Táº¡o ProductVariant phá»©c táº¡p (dÃ¹ng ProductSizeStock Ä‘Æ¡n giáº£n hÆ¡n)
- âŒ DÃ¹ng String cho ProductSlug (dÃ¹ng enum ProductSlug)
- âŒ QuÃªn indexes cho foreign keys
- âŒ QuÃªn `onDelete` strategy cho relations
- âŒ Hardcode magic numbers (dÃ¹ng constants/enums)

### âœ… Do This Instead
- âœ… Sá»­ dá»¥ng ProductSlug enum cho type safety
- âœ… DÃ¹ng ProductSizeStock cho size management
- âœ… ThÃªm indexes cho performance
- âœ… Specify `onDelete` strategy
- âœ… Sá»­ dá»¥ng enums thay vÃ¬ strings
- âœ… Comment rÃµ rÃ ng cho complex models

## ðŸ“‹ Schema Checklist

Khi táº¡o/sá»­a model, Ä‘áº£m báº£o:
- [ ] Model name lÃ  Singular, PascalCase
- [ ] Fields cÃ³ proper types vÃ  constraints
- [ ] Relations cÃ³ proper `onDelete` strategy
- [ ] Indexes Ä‘Æ°á»£c thÃªm cho frequently queried fields
- [ ] Comments giáº£i thÃ­ch cho complex fields
- [ ] Default values cho optional fields
- [ ] Unique constraints náº¿u cáº§n
- [ ] Enum types thay vÃ¬ strings khi cÃ³ thá»ƒ

## ðŸ” Query Optimization

### Best Practices
- **Select Only Needed Fields**: KhÃ´ng select `*`, chá»‰ select fields cáº§n thiáº¿t
- **Use Indexes**: Äáº£m báº£o queries sá»­ dá»¥ng indexes
- **Avoid N+1**: Sá»­ dá»¥ng `include` hoáº·c `select` Ä‘á»ƒ eager load relations
- **Pagination**: LuÃ´n paginate cho list queries

### Example
```typescript
// âœ… Good: Select specific fields, use include
const products = await prisma.product.findMany({
  select: {
    id: true,
    slug: true,
    name: true,
    priceCurrent: true,
    images: {
      select: { url: true, altText: true },
      take: 1
    }
  },
  where: { isPublished: true }
})

// âŒ Bad: Select all, N+1 problem
const products = await prisma.product.findMany()
products.forEach(p => {
  const images = await prisma.productImage.findMany({ where: { productId: p.id } })
})
```
